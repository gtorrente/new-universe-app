[
  {
    "id": "cron-diario",
    "type": "inject",
    "z": "horoscopo-automatico",
    "name": "CRON DiÃ¡rio 06:00",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "00 06 * * *",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "{\"inicio\": true}",
    "payloadType": "json",
    "x": 150,
    "y": 100,
    "wires": [["gerar-lista-signos"]]
  },
  {
    "id": "gerar-lista-signos",
    "type": "function",
    "z": "horoscopo-automatico",
    "name": "Gerar Lista Signos",
    "func": "// ðŸš€ GERAÃ‡ÃƒO AUTOMÃTICA DE HORÃ“SCOPOS DIÃRIOS\n// Executado Ã s 06:00 todos os dias\n\nconsole.log('ðŸ”® INICIANDO GERAÃ‡ÃƒO AUTOMÃTICA DE HORÃ“SCOPOS DIÃRIOS...');\nconsole.log('ðŸ“… Data:', new Date().toLocaleDateString('pt-BR', { \n  weekday: 'long', \n  year: 'numeric', \n  month: 'long', \n  day: 'numeric' \n}));\n\n// Lista completa dos 12 signos\nconst signos = [\n  { en: 'aries', pt: 'Ãries' },\n  { en: 'taurus', pt: 'Touro' },\n  { en: 'gemini', pt: 'GÃªmeos' },\n  { en: 'cancer', pt: 'CÃ¢ncer' },\n  { en: 'leo', pt: 'LeÃ£o' },\n  { en: 'virgo', pt: 'Virgem' },\n  { en: 'libra', pt: 'Libra' },\n  { en: 'scorpio', pt: 'EscorpiÃ£o' },\n  { en: 'sagittarius', pt: 'SagitÃ¡rio' },\n  { en: 'capricorn', pt: 'CapricÃ³rnio' },\n  { en: 'aquarius', pt: 'AquÃ¡rio' },\n  { en: 'pisces', pt: 'Peixes' }\n];\n\n// FunÃ§Ã£o para gerar chave do dia (YYYY-MM-DD)\nfunction getDayKey(date = new Date()) {\n  const year = date.getFullYear();\n  const month = (date.getMonth() + 1).toString().padStart(2, '0');\n  const day = date.getDate().toString().padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\n// FunÃ§Ã£o para nome do dia da semana\nfunction getDayName(date = new Date()) {\n  const diasSemana = ['domingo', 'segunda-feira', 'terÃ§a-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sÃ¡bado'];\n  return diasSemana[date.getDay()];\n}\n\nconst hoje = new Date();\nconst dataChave = getDayKey(hoje);\nconst diaSemana = getDayName(hoje);\n\nconsole.log(`ðŸ“… Chave do dia: ${dataChave}`);\nconsole.log(`ðŸ“… Dia da semana: ${diaSemana}`);\n\n// Criar mensagens para cada signo\nconst mensagens = signos.map((signo, index) => {\n  return {\n    payload: {\n      signo: signo.en,\n      signo_nome: signo.pt,\n      data: dataChave,\n      dia_semana: diaSemana,\n      index: index + 1,\n      total: signos.length\n    },\n    topic: signo.en\n  };\n});\n\nconsole.log(`âœ… Lista gerada: ${signos.length} signos para processamento`);\nconsole.log('ðŸ”„ Enviando para processamento individual...');\n\n// Retornar array de mensagens para o Split node\nreturn [mensagens];",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 350,
    "y": 100,
    "wires": [["split-signos"]]
  },
  {
    "id": "split-signos",
    "type": "split",
    "z": "horoscopo-automatico", 
    "name": "Split Signos",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": 1,
    "arraySpltType": "len",
    "stream": false,
    "addname": "",
    "x": 550,
    "y": 100,
    "wires": [["gerar-prompt-openai"]]
  },
  {
    "id": "gerar-prompt-openai",
    "type": "function",
    "z": "horoscopo-automatico",
    "name": "Gerar Prompt OpenAI",
    "func": "// ðŸ¤– PREPARAR CHAMADA PARA OPENAI\n// Gerar prompt especÃ­fico para cada signo\n\nconst { signo, signo_nome, data, dia_semana, index, total } = msg.payload;\n\nconsole.log(`ðŸ”® [${index}/${total}] Gerando horÃ³scopo para ${signo_nome} (${dia_semana})...`);\n\n// Prompt otimizado baseado no script original\nconst prompt = `VocÃª Ã© um astrologo que vai fazer a previsÃ£o do dia de hoje (${dia_semana}) para o signo ${signo_nome}, e usar o mesmo tom de voz da apresentadora Catia Fonseca, vai finalizar a frase com um emoji e usar atÃ© 220 caracteres.\n\nREQUISITOS:\n- Tom de voz da Catia Fonseca (carismÃ¡tica, calorosa, prÃ³xima)\n- Linguagem acessÃ­vel e motivacional\n- Foco no dia de hoje (${dia_semana})\n- MÃ¡ximo 220 caracteres\n- Finalizar com emoji\n- Sem previsÃµes negativas\n\nEXEMPLO DE TOM:\n\"Oi, ${signo_nome}! Hoje Ã© um dia especial para vocÃª. As energias estÃ£o alinhadas e vocÃª vai se surpreender com as oportunidades que aparecem no seu caminho. Confie na sua intuiÃ§Ã£o! âœ¨\"\n\nIMPORTANTE: Retorne APENAS o texto da previsÃ£o, sem aspas ou formataÃ§Ã£o adicional.`;\n\n// Preparar payload para OpenAI\nmsg.payload = {\n  model: \"gpt-3.5-turbo\",\n  messages: [\n    {\n      role: \"system\",\n      content: \"VocÃª Ã© a apresentadora Catia Fonseca, especialista em astrologia. Use um tom carismÃ¡tico, caloroso e prÃ³ximo. Sempre seja positiva e motivacional.\"\n    },\n    {\n      role: \"user\",\n      content: prompt\n    }\n  ],\n  temperature: 0.8,\n  max_tokens: 150\n};\n\n// Manter dados do signo para prÃ³ximas etapas\nmsg.signo_dados = {\n  signo: signo,\n  signo_nome: signo_nome,\n  data: data,\n  dia_semana: dia_semana,\n  index: index,\n  total: total\n};\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 100,
    "wires": [["chamar-openai"]]
  },
  {
    "id": "chamar-openai",
    "type": "http request",
    "z": "horoscopo-automatico",
    "name": "Chamar OpenAI",
    "method": "POST",
    "ret": "obj",
    "paytoqs": "ignore",
    "url": "https://api.openai.com/v1/chat/completions",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "bearer",
    "senderr": false,
    "headers": [
      {
        "keyType": "Content-Type",
        "keyValue": "",
        "valueType": "application/json",
        "valueValue": ""
      }
    ],
    "credentials": {
      "token": "YOUR_OPENAI_API_KEY_HERE"
    },
    "x": 1000,
    "y": 100,
    "wires": [["processar-resposta-openai"]]
  },
  {
    "id": "processar-resposta-openai",
    "type": "function",
    "z": "horoscopo-automatico",
    "name": "Processar Resposta OpenAI",
    "func": "// ðŸ“ PROCESSAR RESPOSTA DA OPENAI\n// Extrair e formatar o horÃ³scopo gerado\n\nconst { signo, signo_nome, data, dia_semana, index, total } = msg.signo_dados;\n\nconsole.log(`ðŸ“ [${index}/${total}] Processando resposta para ${signo_nome}...`);\n\n// Verificar se houve erro na API\nif (msg.statusCode !== 200) {\n  console.error(`âŒ [${index}/${total}] Erro na OpenAI para ${signo_nome}:`, msg.statusCode);\n  console.error('Resposta:', msg.payload);\n  \n  // Usar horÃ³scopo de fallback\n  var horoscopoTexto = `Hoje Ã© um dia de renovaÃ§Ã£o para ${signo_nome}! As energias cÃ³smicas trazem novas oportunidades. Mantenha-se aberto ao que vier! âœ¨`;\n} else {\n  // Extrair texto da resposta\n  try {\n    var horoscopoTexto = msg.payload.choices[0].message.content.trim();\n    \n    // Verificar se tem emoji no final\n    if (!/\\p{Emoji}/u.test(horoscopoTexto)) {\n      console.warn(`âš ï¸ [${index}/${total}] HorÃ³scopo para ${signo_nome} nÃ£o tem emoji, adicionando...`);\n      horoscopoTexto += ' âœ¨';\n    }\n    \n    // Limitar caracteres\n    if (horoscopoTexto.length > 220) {\n      console.warn(`âš ï¸ [${index}/${total}] HorÃ³scopo para ${signo_nome} muito longo, cortando...`);\n      horoscopoTexto = horoscopoTexto.substring(0, 217) + '...';\n    }\n    \n    console.log(`âœ… [${index}/${total}] HorÃ³scopo gerado para ${signo_nome}: ${horoscopoTexto.length} caracteres`);\n    \n  } catch (error) {\n    console.error(`âŒ [${index}/${total}] Erro ao processar resposta para ${signo_nome}:`, error);\n    // Usar fallback\n    var horoscopoTexto = `Hoje Ã© um dia especial para ${signo_nome}! As estrelas indicam momentos de alegria e realizaÃ§Ãµes. Aproveite! âœ¨`;\n  }\n}\n\n// Preparar documento para Firestore\nconst documentoFirestore = {\n  fields: {\n    mensagem: {\n      stringValue: horoscopoTexto\n    },\n    signo: {\n      stringValue: signo\n    },\n    nome_signo: {\n      stringValue: signo_nome\n    },\n    dia_semana: {\n      stringValue: dia_semana\n    },\n    data: {\n      stringValue: data\n    },\n    fonte: {\n      stringValue: \"catia-fonseca\"\n    },\n    gerado_em: {\n      timestampValue: new Date().toISOString()\n    },\n    versao: {\n      stringValue: \"node-red-v1\"\n    }\n  }\n};\n\n// URL do Firestore para salvar\nconst urlFirestore = `https://firestore.googleapis.com/v1/projects/tarot-universo-catia/databases/(default)/documents/horoscopos_diarios/${data}/signos/${signo}`;\n\nconsole.log(`ðŸ’¾ [${index}/${total}] Salvando ${signo_nome} no Firebase...`);\n\n// Preparar mensagem para salvar no Firestore\nmsg.url = urlFirestore;\nmsg.method = 'PATCH';\nmsg.headers = {\n  'Content-Type': 'application/json'\n};\nmsg.payload = documentoFirestore;\n\n// Manter dados para o join final\nmsg.signo_resultado = {\n  signo: signo,\n  signo_nome: signo_nome,\n  data: data,\n  horoscopo: horoscopoTexto,\n  index: index,\n  total: total\n};\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1250,
    "y": 100,
    "wires": [["salvar-firestore"]]
  },
  {
    "id": "salvar-firestore",
    "type": "http request",
    "z": "horoscopo-automatico",
    "name": "Salvar Firestore",
    "method": "use",
    "ret": "obj",
    "paytoqs": "ignore",
    "url": "",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "",
    "senderr": false,
    "headers": [],
    "x": 1470,
    "y": 100,
    "wires": [["processar-resultado"]]
  },
  {
    "id": "processar-resultado",
    "type": "function",
    "z": "horoscopo-automatico",
    "name": "Processar Resultado",
    "func": "// ðŸ“Š PROCESSAR RESULTADO DO SALVAMENTO\n// Verificar se houve sucesso e preparar para join\n\nconst { signo, signo_nome, data, horoscopo, index, total } = msg.signo_resultado;\n\n// Verificar se salvou com sucesso\nif (msg.statusCode === 200) {\n  console.log(`âœ… [${index}/${total}] ${signo_nome} salvo com sucesso no Firebase!`);\n  msg.sucesso = true;\n} else {\n  console.error(`âŒ [${index}/${total}] Erro ao salvar ${signo_nome}:`, msg.statusCode, msg.payload);\n  msg.sucesso = false;\n}\n\n// Preparar dados para o join\nmsg.payload = {\n  signo: signo,\n  signo_nome: signo_nome,\n  data: data,\n  horoscopo: horoscopo,\n  index: index,\n  total: total,\n  sucesso: msg.sucesso,\n  timestamp: new Date().toISOString()\n};\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1690,
    "y": 100,
    "wires": [["join-resultados"]]
  },
  {
    "id": "join-resultados",
    "type": "join",
    "z": "horoscopo-automatico",
    "name": "Join Resultados",
    "mode": "custom",
    "build": "array",
    "property": "payload",
    "propertyType": "msg",
    "key": "topic",
    "joiner": "\\n",
    "joinerType": "str",
    "accumulate": false,
    "timeout": "",
    "count": "12",
    "reduceRight": false,
    "reduceExp": "",
    "reduceInit": "",
    "reduceInitType": "",
    "reduceFixup": "",
    "x": 1910,
    "y": 100,
    "wires": [["log-final-automatico"]]
  },
  {
    "id": "log-final-automatico",
    "type": "function",
    "z": "horoscopo-automatico",
    "name": "Log Final AutomÃ¡tico",
    "func": "// ðŸŽ‰ LOG FINAL DA GERAÃ‡ÃƒO AUTOMÃTICA\n// Consolidar resultados e estatÃ­sticas\n\nconst resultados = msg.payload;\nconst dataInicio = new Date();\n\nconsole.log('\\n'.repeat(3));\nconsole.log('ðŸŽ‰ ='.repeat(50));\nconsole.log('ðŸŽ‰ GERAÃ‡ÃƒO AUTOMÃTICA DE HORÃ“SCOPOS DIÃRIOS CONCLUÃDA!');\nconsole.log('ðŸŽ‰ ='.repeat(50));\n\nconst sucessos = resultados.filter(r => r.sucesso);\nconst falhas = resultados.filter(r => !r.sucesso);\n\nconsole.log(`ðŸ“Š ESTATÃSTICAS:`);\nconsole.log(`   ðŸ“… Data: ${resultados[0]?.data || 'N/A'}`);\nconsole.log(`   âœ… Sucessos: ${sucessos.length}/12`);\nconsole.log(`   âŒ Falhas: ${falhas.length}/12`);\nconsole.log(`   ðŸ“ˆ Taxa de sucesso: ${((sucessos.length/12) * 100).toFixed(1)}%`);\n\nif (sucessos.length > 0) {\n  console.log(`\\nâœ… SIGNOS GERADOS COM SUCESSO:`);\n  sucessos.forEach(r => {\n    console.log(`   ðŸ”® ${r.signo_nome}: \"${r.horoscopo.substring(0, 50)}...\"`);\n  });\n}\n\nif (falhas.length > 0) {\n  console.log(`\\nâŒ SIGNOS COM FALHA:`);\n  falhas.forEach(r => {\n    console.log(`   âš ï¸ ${r.signo_nome} (${r.signo})`);\n  });\n}\n\n// Salvar status da geraÃ§Ã£o no Firestore\nconst statusDoc = {\n  fields: {\n    data: {\n      stringValue: resultados[0]?.data || new Date().toISOString().split('T')[0]\n    },\n    total_signos: {\n      integerValue: \"12\"\n    },\n    sucessos: {\n      integerValue: sucessos.length.toString()\n    },\n    falhas: {\n      integerValue: falhas.length.toString()\n    },\n    taxa_sucesso: {\n      doubleValue: (sucessos.length/12) * 100\n    },\n    gerado_em: {\n      timestampValue: new Date().toISOString()\n    },\n    metodo: {\n      stringValue: \"node-red-automatico\"\n    },\n    signos_sucesso: {\n      arrayValue: {\n        values: sucessos.map(r => ({ stringValue: r.signo }))\n      }\n    },\n    signos_falha: {\n      arrayValue: {\n        values: falhas.map(r => ({ stringValue: r.signo }))\n      }\n    }\n  }\n};\n\nconst dataChave = resultados[0]?.data || new Date().toISOString().split('T')[0];\nconst urlStatus = `https://firestore.googleapis.com/v1/projects/tarot-universo-catia/databases/(default)/documents/horoscopos_diarios/${dataChave}/config/status`;\n\nconsole.log(`\\nðŸ’¾ Salvando status da geraÃ§Ã£o...`);\n\nmsg.url = urlStatus;\nmsg.method = 'PATCH';\nmsg.headers = {\n  'Content-Type': 'application/json'\n};\nmsg.payload = statusDoc;\n\nconsole.log('='.repeat(50));\nconsole.log(`ðŸš€ PRÃ“XIMA EXECUÃ‡ÃƒO: AmanhÃ£ Ã s 06:00`);\nconsole.log('='.repeat(50));\nconsole.log('\\n'.repeat(2));\n\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2150,
    "y": 100,
    "wires": [["salvar-status-final"]]
  },
  {
    "id": "salvar-status-final",
    "type": "http request",
    "z": "horoscopo-automatico",
    "name": "Salvar Status Final",
    "method": "use",
    "ret": "obj",
    "paytoqs": "ignore",
    "url": "",
    "tls": "",
    "persist": false,
    "proxy": "",
    "authType": "",
    "senderr": false,
    "headers": [],
    "x": 2380,
    "y": 100,
    "wires": [[]]
  },
  {
    "id": "teste-manual",
    "type": "inject",
    "z": "horoscopo-automatico",
    "name": "ðŸ§ª Teste Manual",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "{\"teste\": true}",
    "payloadType": "json",
    "x": 150,
    "y": 200,
    "wires": [["gerar-lista-signos"]]
  }
]